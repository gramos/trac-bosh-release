set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Available variables
# $BOSH_COMPILE_TARGET - where this package & spec'd source files are available
# $BOSH_INSTALL_TARGET - where you copy/install files to be included in package

export HOME=/var/vcap
export PYTHON_BIN=/var/vcap/packages/python/bin/python

export PYTHONPATH=/var/vcap/packages/python:/var/vcap/packages/trac/trac:/var/vcap/packages/trac/trac
export PYTHONUSERBASE=$BOSH_INSTALL_TARGET/trac

echo "Installing setuptools..."
curl https://pypi.python.org/packages/source/s/setuptools/setuptools-1.3.1.tar.gz > setuptools-1.3.1.tar.gz
tar xzf setuptools-1.3.1.tar.gz

# -------------------------------------------------------------------
cd setuptools-1.3.1
mkdir -p $BOSH_INSTALL_TARGET/trac/lib/python
$PYTHON_BIN setup.py install --user
cd ..

# -------------------------------------------------------------------
echo "Installing pysqlite..."
curl https://pypi.python.org/packages/source/p/pysqlite/pysqlite-2.6.3.tar.gz > pysqlite-2.6.3.tar.gz
tar xfz pysqlite-2.6.3.tar.gz
cd pysqlite-2.6.3
CFLAGS=-I/var/vcap/packages/sqlite/include $PYTHON_BIN setup.py install --user


# -------------------------------------------------------------------
echo "Extracting trac..."
tar xzf trac/Trac-1.0.1.tar.gz

# -------------------------------------------------------------------
echo "Installing trac..."
cd Trac-1.0.1
$PYTHON_BIN setup.py install --home $BOSH_INSTALL_TARGET/trac
export PATH=$PATH:$BOSH_INSTALL_TARGET/trac/bin

# -------------------------------------------------------------------
echo "Creating trac project..."
trac-admin $BOSH_INSTALL_TARGET/mytracproject initenv "My Project" sqlite:db/myproject.db

# -------------------------------------------------------------------
echo "Giving permissions to /usr/local/mytracproject/conf/trac.ini"
chmod a+r $BOSH_INSTALL_TARGET/mytracproject/conf/trac.ini

